name: Deploy Release

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
  workflow_dispatch:

env:
  PLUGIN_NAME: 'local_questionconverter'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.11.0
      
      - name: Obtener version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION=$(echo "${{ github.ref }}" | sed 's|refs/tags/v||')
          else
            VERSION=$(date +%Y%m%d-%H%M%S)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      
      - name: Build Tailwind CSS
        working-directory: tailwindcss
        run: |
          npm install
          npm run build

      - name: Build AMD (Moodle)
        run: |
          git clone -b MOODLE_405_STABLE --depth 1 https://github.com/moodle/moodle.git /tmp/moodle
          rm -rf /tmp/moodle/local/questionconverter
          mkdir -p /tmp/moodle/local
          rsync -a --delete ./ /tmp/moodle/local/questionconverter/
          cd /tmp/moodle
          npm install
          npx grunt amd --force
          mkdir -p ${GITHUB_WORKSPACE}/amd/build
          rsync -a --delete /tmp/moodle/local/questionconverter/amd/build/ ${GITHUB_WORKSPACE}/amd/build/

      - name: Preparando archivo del plugin
        run: |
          echo "Limpiando los archivo inncesesarios..."
          rm -rf /tmp/build
          mkdir -p /tmp/build/questionconverter
          rsync -a \
            --exclude .git \
            --exclude .github \
            --exclude .gitignore \
            --exclude node_modules \
            --exclude tests \
            --exclude .vscode \
            --exclude ".DS_Store" \
            ./ /tmp/build/questionconverter/
          if [[ ! -d "/tmp/build/questionconverter/tailwindcss/dist" ]]; then
            echo "ERROR: No se encontró tailwindcss/dist en el build" >&2
            exit 1
          fi
          if [[ ! -d "/tmp/build/questionconverter/amd/build" ]]; then
            echo "ERROR: No se encontró amd/build en el build" >&2
            exit 1
          fi
          echo "Archivos preparados!"
          ls -la /tmp/build/questionconverter

      - name: Create ZIP for Moodle
        run: |
          echo "Creando ZIP para: ${{ env.PLUGIN_NAME }}"
          cd /tmp/build
          zip -r ${{ env.PLUGIN_NAME }}.zip questionconverter
          mv ${{ env.PLUGIN_NAME }}.zip ${GITHUB_WORKSPACE}/
          cd ${GITHUB_WORKSPACE}
          echo "ZIP creado correctamente"
          ls -lh ${{ env.PLUGIN_NAME }}.zip
          unzip -l ${{ env.PLUGIN_NAME }}.zip | head -20
        
      - name: Upload artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-${{ steps.version.outputs.version }}
          path: "${{ env.PLUGIN_NAME }}.zip"
          retention-days: 30