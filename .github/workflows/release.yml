name: Deploy Release

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
  workflow_dispatch:

env:
  PLUGIN_NAME: 'local_questionconverter'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Obtener version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION=$(echo "${{ github.ref }}" | sed 's|refs/tags/v||')
          else
            VERSION=$(date +%Y%m%d-%H%M%S)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      
      - name: Preparando archivo del plugin
        run: |
          echo "Limpiando los archivo inncesesarios..."
          rm -rf .git .github .gitignore node_modules tests .vscode
          find . -name ".DS_Store" -delete
          echo "Archivos limpiados!"
          ls -la

      - name: Create ZIP for Moodle
        run: |
          echo "Creando ZIP para: ${{ env.PLUGIN_NAME }}"
          PLUGIN_DIR="questionconverter"
          mkdir -p /tmp/build/${PLUGIN_DIR}
          cp -r ./* /tmp/build/${PLUGIN_DIR}/ 2>/dev/null || true
          ls -la /tmp/build/${PLUGIN_DIR}/
          cd /tmp/build
          zip -r ${{ env.PLUGIN_NAME }}.zip ${PLUGIN_DIR}
          mv ${{ env.PLUGIN_NAME }}.zip ${GITHUB_WORKSPACE}/
          cd ${GITHUB_WORKSPACE}
          echo "ZIP creado correctamente"
          ls -lh ${{ env.PLUGIN_NAME }}.zip
          unzip -l ${{ env.PLUGIN_NAME }}.zip | head -20
        
      - name: Upload artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_NAME }}-${{ steps.version.outputs.version }}
          path: "${{ env.PLUGIN_NAME }}.zip"
          retention-days: 30