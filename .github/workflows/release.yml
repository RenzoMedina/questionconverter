name: Deploy Release

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
  workflow_dispatch:

env:
  PLUGIN_NAME: 'questionvonverter'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Obtener version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION=$(echo "${{ github.ref }}" | sed 's|refs/tags/v||')
          else
            VERSION=$(date +%Y%m%d-%H%M%S)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      
      - name: Preparando archivo del plugin
        run: |
          echo "Limpiando los archivo inncesesarios..."
          rm -rf .git .github .gitignore node_modules tests .vscode
          find . -name ".DS_Store" -delete
          echo "Archivos limpiados!"
          ls -la

      - name: Create ZIP for Moodle
        run: |
          echo "Creando ZIP para: ${{ env.PLUGIN_NAME }}"
          mkdir -p /tmp/build/${{ env.PLUGIN_NAME }}
          cp -r ./* /tmp/build/${{ env.PLUGIN_NAME }}/ 2>/dev/null || true
          ls -la /tmp/build/${{ env.PLUGIN_NAME }}/
          cd /tmp/build
          zip -r ${{ env.PLUGIN_NAME }}.zip ${{ env.PLUGIN_NAME }}
          mv ${{ env.PLUGIN_NAME }}.zip ${GITHUB_WORKSPACE}/
          cd ${GITHUB_WORKSPACE}
          echo "ZIP creado correctamente"
          ls -lh ${{ env.PLUGIN_NAME }}.zip
          unzip -l ${{ env.PLUGIN_NAME }}.zip | head -20

      - name: Crear Release en GitHub
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v1
        with:
          files: "${{ env.PLUGIN_NAME }}.zip"
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Upload artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.plugin_info.outputs.name }}-${{ steps.plugin_info.outputs.version }}
          path: "${{ env.PLUGIN_NAME }}.zip"
          retention-days: 30