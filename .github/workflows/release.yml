name: Deploy Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get plugin
        id: plugin_info
        run: |
          if [ -f "version.php" ]; then
            PLUGIN_NAME=$(grep -oP "(?<=component = ')[^']*" version.php | sed 's/local_//')
          else
            # Fallback al nombre del repositorio
            PLUGIN_NAME=$(basename ${{ github.repository }})
          fi
          echo "name=${PLUGIN_NAME}" >> $GITHUB_OUTPUT
          
          if [[ ${{ github.ref }} == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(date +%Y%m%d-%H%M%S)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create ZIP for Moodle
        run: |
          mkdir -p temp/${PLUGIN_NAME}
          
          rsync -av --progress . temp/${PLUGIN_NAME} \
            --exclude .git \
            --exclude .github \
            --exclude node_modules \
            --exclude tests \
            --exclude temp \
            --exclude .gitignore
          
          cd temp
          zip -r ../${PLUGIN_NAME}.zip ${PLUGIN_NAME}
          cd ..
          
          rm -rf temp
          
          echo "Created: ${PLUGIN_NAME}.zip"
          ls -lh ${PLUGIN_NAME}.zip

      - name: Create Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v1
        with:
          files: "*.zip"
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Upload artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.plugin_info.outputs.name }}-${{ steps.plugin_info.outputs.version }}
          path: "*.zip"
          retention-days: 30