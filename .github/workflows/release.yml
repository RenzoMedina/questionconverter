name: Deploy Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        width:
          path: plugin
      
      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(date +%Y%m%d-%H%M%S)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      
      - name: Get plugin name
        id: plugin
        run: |
          cd plugin
          if [ -f "version.php" ]; then
            COMPONENT=$(grep -oP "(?<=component = ')[^']*" version.php || echo "")
            if [ -n "$COMPONENT" ]; then
                PLUGIN_NAME=$(echo $COMPONENT | sed 's/local_//')
              fi
          fi
          if [ -z "$PLUGIN_NAME" ]; then
            PLUGIN_NAME=$(basename ${{ github.repository }})
          fi
          
          echo "name=${PLUGIN_NAME}" >> $GITHUB_OUTPUT
          echo "Plugin name: ${PLUGIN_NAME}"

      - name: Create ZIP for Moodle
        run: |
          PLUGIN_NAME="${{ steps.plugin.outputs.name }}"
          cd plugin
          rm -rf .git .github .gitignore node_modules tests
          find . -name ".DS_Store" -type f -delete
          
          cd ..
          mv plugin ${PLUGIN_NAME}
          zip -r ${PLUGIN_NAME}.zip ${PLUGIN_NAME}
          echo  "Created: ${PLUGIN_NAME}.zip"
          ls -lh ${PLUGIN_NAME}.zip

      - name: Create Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v1
        with:
          files: "*.zip"
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Upload artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.plugin_info.outputs.name }}-${{ steps.plugin_info.outputs.version }}
          path: "*.zip"
          retention-days: 30